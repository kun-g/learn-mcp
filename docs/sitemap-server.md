# Sitemap MCP Server

## 概述

Sitemap MCP Server 是一个基于 FastMCP 框架构建的 XML sitemap 解析和分析服务器，专门用于分析网站的 sitemap 文件并提供丰富的分析功能，包括 URL 统计、更新模式分析和网站结构洞察。

## 核心功能

### 1. 基础解析功能

#### `parse_sitemap(url: str)`
- **功能**: 解析 sitemap XML 并提取所有 URL
- **支持格式**: 标准 sitemap 和 sitemap index
- **返回内容**: URL 列表、总数、sitemap 类型等基础信息
- **进度反馈**: 实时报告下载、解析和提取进度

#### `validate_sitemap(url: str)`
- **功能**: 验证 sitemap 是否符合 XML sitemap 协议标准
- **检查项**:
  - URL 数量限制（50,000 个）
  - 文件大小限制（50MB）
  - URL 格式验证
  - XML 结构完整性
- **返回内容**: 验证结果、问题列表、警告信息

### 2. 分析功能

#### `analyze_sitemap(url: str)`
- **功能**: 提供 sitemap 的详细统计分析
- **分析维度**:
  - 域名分布统计
  - 路径模式分析
  - 文件扩展名统计
  - URL 结构洞察
- **输出**: 排序后的统计数据，便于理解网站结构

#### `extract_domain_info(url: str, limit: int = 10)`
- **功能**: 提取和分析域名信息
- **分析内容**:
  - 每个域名的 URL 数量
  - 示例 URL 列表
  - 路径分布
  - 协议使用情况（HTTP/HTTPS）
- **用途**: 跨域分析、子域名发现

### 3. 更新追踪功能

#### `analyze_update_patterns(url: str)`
- **功能**: 分析网站更新模式和频率
- **分析维度**:
  - **更新频率分布**: 统计各种 `changefreq` 值的使用情况
  - **优先级分析**: 分析 `priority` 值的分布
  - **时间范围分析**: 找出最早和最新的更新时间
  - **近期活动**: 统计最近 7 天和 30 天的更新数量
  - **域名级统计**: 按域名分组的更新模式
- **实际应用**: 内容更新策略优化、网站活跃度评估

### 4. 资源接口

#### `data://sitemap/{url}`
- **功能**: 获取 sitemap 的缓存数据
- **内容**: 基础解析结果的快速访问接口
- **格式**: JSON 格式，包含 URL、类型、总数等信息

#### `data://sitemap/updates/{url}`
- **功能**: 获取详细的更新记录和模式分析
- **内容**:
  - 元数据覆盖率统计
  - 更新模式分析结果
  - 最近更新记录（按时间排序）
  - 示例 URL 和完整元数据
- **用途**: 更新历史追踪、内容策略分析

## 设计思路

### 1. 架构设计

```
sitemap_server.py
├── 核心解析层
│   ├── _parse_sitemap_internal()     # 内部解析逻辑
│   ├── _extract_urls()              # URL 提取（兼容性）
│   └── _extract_url_details()       # 详细信息提取
├── 分析处理层
│   ├── _analyze_update_patterns()   # 更新模式分析
│   ├── _get_recent_updates()        # 最近更新提取
│   └── _detect_sitemap_type()       # 类型检测
├── 工具接口层
│   ├── parse_sitemap()              # 基础解析
│   ├── analyze_sitemap()            # 统计分析
│   ├── validate_sitemap()           # 协议验证
│   ├── extract_domain_info()        # 域名分析
│   └── analyze_update_patterns()    # 更新分析
└── 资源接口层
    ├── get_sitemap_data()           # 基础数据资源
    └── get_sitemap_updates()        # 更新数据资源
```

### 2. 数据流设计

1. **输入阶段**: 接收 sitemap URL
2. **获取阶段**: 通过 HTTP 请求获取 XML 内容
3. **解析阶段**: 使用 xmltodict 解析 XML 结构
4. **提取阶段**: 分别提取 URL 和元数据信息
5. **分析阶段**: 根据不同需求进行统计和模式分析
6. **输出阶段**: 返回结构化的 JSON 结果

### 3. 错误处理策略

- **网络层错误**: 捕获 RequestException，返回网络请求错误信息
- **解析层错误**: 捕获 XML 解析异常，返回解析错误信息
- **数据层错误**: 处理缺失字段和格式异常
- **用户友好**: 所有错误信息使用中文描述，便于理解

### 4. 性能优化

- **分层处理**: 内部函数复用，避免重复解析
- **增量加载**: 支持限制返回数量，避免大数据集性能问题
- **进度反馈**: 长时间操作提供进度报告
- **类型优化**: 使用类型提示提高代码质量

## 技术特点

### 1. 兼容性设计
- 同时支持标准 sitemap 和 sitemap index 格式
- 向后兼容原有的 `_extract_urls()` 函数
- 处理各种日期格式（ISO 8601、简单日期）

### 2. 扩展性考虑
- 模块化函数设计，便于功能扩展
- 清晰的接口分离，工具和资源分开管理
- 统一的错误处理和返回格式

### 3. 用户体验
- 中文错误信息和进度提示
- 结构化的 JSON 输出
- 合理的数据分页和限制

## 使用场景

### 1. SEO 分析
- 分析网站 URL 结构和分布
- 检查 sitemap 协议合规性
- 评估页面优先级设置

### 2. 内容审计
- 跟踪网站内容更新频率
- 识别活跃和非活跃内容区域
- 分析内容更新策略效果

### 3. 网站监控
- 定期检查 sitemap 变化
- 监控新增和删除的页面
- 跟踪网站结构演变

### 4. 竞争分析
- 分析竞争对手网站结构
- 了解行业内容更新模式
- 发现潜在的内容机会

## 开发指南

### 测试策略
- 单元测试覆盖所有核心函数
- 模拟网络请求和 XML 解析
- 测试各种边界情况和错误场景

### 扩展方向
1. **缓存机制**: 添加 Redis 或内存缓存
2. **批量处理**: 支持同时分析多个 sitemap
3. **历史追踪**: 保存和比较历史数据
4. **可视化**: 生成图表和报告
5. **通知机制**: 变化检测和告警

### 配置要求
- Python 3.8+
- FastMCP 框架
- requests 和 xmltodict 依赖
- 稳定的网络连接

这个 MCP 服务器为 AI 助手提供了强大的 sitemap 分析能力，能够深入理解网站结构和内容更新规律，为各种 SEO 和内容策略提供数据支持。